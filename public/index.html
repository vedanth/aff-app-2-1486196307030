<!DOCTYPE html>
<html lang="en" class="no-js">
<!--<![endif]-->
<!-- BEGIN HEAD -->
<head>
<meta charset="utf-8"/>
<title>Afforde | Dashboard</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="" name="description"/>
<meta content="" name="author"/>
<!-- BEGIN GLOBAL MANDATORY STYLES -->
<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&subset=all" rel="stylesheet" type="text/css"/>
<link href="plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
<link href="plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="plugins/datetimepicker/jquery.datetimepicker.css"/>

    <link href="plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<!-- END GLOBAL MANDATORY STYLES -->
<!-- END PAGE STYLES -->
<!-- BEGIN THEME STYLES -->
<link href="plugins/css/components-md.css" id="style_components" rel="stylesheet" type="text/css"/>
<link href="plugins/layout/css/layout.css" rel="stylesheet" type="text/css"/>
<link href="plugins/layout/css/themes/darkblue.css" rel="stylesheet" type="text/css" id="style_color"/>
 <link href="plugins/bootstrap/css/toogle.css" rel="stylesheet" type="text/css"/>

    <style type="text/css">

input{
     color:black;
    }
  </style>
    <!-- END THEME STYLES -->

</head>
<body class="page-md page-header-fixed page-quick-sidebar-over-content page-sidebar-closed-hide-logo ">
<!-- BEGIN HEADER -->
<div class="page-header md-shadow-z-1-i navbar navbar-fixed-top">
	<!-- BEGIN HEADER INNER -->
	<div class="page-header-inner">
		<!-- BEGIN LOGO -->
		<div class="page-logo">
			<a href="index.html">
			<img src="images/tekaffore_medium_blue.png" alt="logo" class="logo-default"/>
			</a>
			<div class="menu-toggler sidebar-toggler hide">
			</div>
		</div>
		<!-- END LOGO -->
		<!-- BEGIN RESPONSIVE MENU TOGGLER -->
		<a href="javascript:;" class="menu-toggler responsive-toggler" data-toggle="collapse" data-target=".navbar-collapse">
		</a>
		<!-- END RESPONSIVE MENU TOGGLER -->
		<!-- BEGIN TOP NAVIGATION MENU -->
		<div class="top-menu">
			<ul class="nav navbar-nav pull-right">
				<!-- BEGIN NOTIFICATION DROPDOWN -->
				<!-- DOC: Apply "dropdown-dark" class after below "dropdown-extended" to change the dropdown styte -->
				<li class="dropdown dropdown-extended dropdown-notification" id="header_notification_bar">
					<a href="javascript:;" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
					<i class="icon-bell"></i>
					<span class="badge badge-default">
					</span>
					</a>
					<ul class="dropdown-menu">
						<li class="external">
							<h3><span class="bold">12 pending</span> notifications</h3>
							<a href="extra_profile.html">view all</a>
						</li>
							</ul>
				</li>
				<li class="dropdown dropdown-user">
					<a href="javascript:;" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
					<img alt="" class="img-circle" src="images/avatar.png"/>
					<span class="username username-hide-on-mobile">
					Affuser </span>
					<i class="fa fa-angle-down"></i>
					</a>
					<ul class="dropdown-menu dropdown-menu-default">
						<li>
							<a href="extra_profile.html">
							<i class="icon-user"></i> My Profile </a>
						</li>
						<li class="divider">
						</li>
						<li>
							<a href="login.html">
							<i class="icon-key"></i> Log Out </a>
						</li>
					</ul>
				</li>
				<li class="dropdown dropdown-quick-sidebar-toggler">
					<a href="javascript:;" class="dropdown-toggle">
					<i class="icon-logout"></i>
					</a>
				</li>
				<!-- END QUICK SIDEBAR TOGGLER -->
			</ul>
		</div>
		<!-- END TOP NAVIGATION MENU -->
	</div>
	<!-- END HEADER INNER -->
</div>
<!-- END HEADER -->
<div class="clearfix">
</div>
<!-- BEGIN CONTAINER -->
<div class="page-container">
	<!-- BEGIN SIDEBAR -->
	<div class="page-sidebar-wrapper">
		<div class="page-sidebar navbar-collapse collapse">
			<ul class="page-sidebar-menu page-sidebar-menu-light" data-keep-expanded="false" data-auto-scroll="true" data-slide-speed="200">
				<!-- DOC: To remove the sidebar toggler from the sidebar you just need to completely remove the below "sidebar-toggler-wrapper" LI element -->
				<li class="sidebar-toggler-wrapper">
					<!-- BEGIN SIDEBAR TOGGLER BUTTON -->
					<div class="sidebar-toggler">
					</div>
					<!-- END SIDEBAR TOGGLER BUTTON -->
				</li>
				<!-- DOC: To remove the search box from the sidebar you just need to completely remove the below "sidebar-search-wrapper" LI element -->
				<li class="start active open">
					<a href="javascript:;">
					<i class="icon-home"></i>
					<span class="title">Dashboard</span>
					<span class="selected"></span>
					<span class="arrow open"></span>
					</a>

				</li>
				<li>
					<a href="javascript:;">
					<i class="icon-settings"></i>
					<span class="title">Settings</span>
					<span class="arrow "></span>
					</a>
					</li>
					</ul>
			<!-- END SIDEBAR MENU -->
		</div>
	</div>
	<!-- END SIDEBAR -->
	<!-- BEGIN CONTENT -->
	<div class="page-content-wrapper">
		<div class="page-content">
			<h3 class="page-title">
			Dashboard <small>reports & statistics</small>
			</h3>
			<div class="page-bar">
				<ul class="page-breadcrumb">
					<li>
						<i class="fa fa-home"></i>
						<a href="index.html">Home</a>
						<i class="fa fa-angle-right"></i>
					</li>
					<li>
						<a href="#">Dashboard</a>
					</li>
				</ul>

			</div>
			<!-- END PAGE HEADER-->
			<div class="clearfix">
			</div>

            <div class="row">
                <div class="col-md-12">
                    <div class="portlet box blue">


                        <div class="portlet-title">
                            <div class="caption">
                                <i class="fa fa-line-chart"></i>Trending Chart

                            </div>
                            <div class="actions">

                                <div class="btn-group">

                                    <button id="datetimepicker" class="btn"><i class="fa fa-calendar"></i></button>
                                    <button id="search_btn" class="btn">Search</button>
                                </div>
                                <div class="btn-group">
                                    <a href="" class="btn grey-salsa btn-circle btn-sm dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
                                        Criteria<span class="fa fa-angle-down">
									</span>
                                    </a>
                                    <ul class="dropdown-menu pull-right">
                                        <li>
                                            <a href="javascript:;" key="nominal_power" onclick="setDatasetKey(this);">
                                                Nominal Power
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" key="active_power" onclick="setDatasetKey(this);">
                                                Active Power
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" key="apprent_power" onclick="setDatasetKey(this);">
                                                Apprent Power
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" key="line_voltage" onclick="setDatasetKey(this);">
                                                Line Voltage
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" key="power_factor" onclick="setDatasetKey(this);">
                                                Power Factor
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" key="current" onclick="setDatasetKey(this);">
                                                Current
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" key="energy" onclick="setDatasetKey(this);">
                                                Energy
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" key="coolant" onclick="setDatasetKey(this);">
                                                Coolant
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" key="battery" onclick="setDatasetKey(this);">
                                                Battery
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="portlet-body">

                            <div class="row">
                                <div class="col-md-9">
                                    <h3 class="page-title selected_criteria">
                                        Active Power
                                    </h3>
                                </div>
                                <div class="col-md-3">

                                    <input id="trend_check_box" data-size="mini" data-toggle="toggle" type="checkbox" value="Show Current Trend" checked> Show Current Trend
                                </div>
                            </div>


                            <canvas id="myChart" width="1000" height="300"></canvas>
                        </div>


                    </div>
                </div>
            </div>

            <div class="row">

          <!--  <div class="col-md-6">
                &lt;!&ndash; BEGIN PORTLET&ndash;&gt;
                <div class="portlet box blue">


                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-gift"></i>Trending Chart

                        </div>
                        <div class="actions">
                            <div class="btn-group">
                                <input type="text" value="" id="datetimepicker"/>
                                <ul class="dropdown-menu pull-right">
                                    <li>
                                        <a href="javascript:;" key="1" onclick="setDatasetTime(this);">
                                            1 min
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="15" onclick="setDatasetTime(this);">
                                            15 min
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="30" onclick="setDatasetTime(this);">
                                            30 min
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="45" onclick="setDatasetTime(this);">
                                            45 min
                                        </a>
                                    </li>

                                </ul>
                            </div>
                            <div class="btn-group">
                                <a href="" class="btn grey-salsa btn-circle btn-sm dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
                                    Criteria<span class="fa fa-angle-down">
									</span>
                                </a>
                                <ul class="dropdown-menu pull-right">
                                    <li>
                                        <a href="javascript:;" key="nominal_power" onclick="setDatasetKey(this);">
                                            Nominal Power
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="active_power" onclick="setDatasetKey(this);">
                                            Active Power
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="apprent_power" onclick="setDatasetKey(this);">
                                            Apprent_power
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="line_voltage" onclick="setDatasetKey(this);">
                                            Line Voltage
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="power_factor" onclick="setDatasetKey(this);">
                                            Power Factor
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="current" onclick="setDatasetKey(this);">
                                            Current
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="energy" onclick="setDatasetKey(this);">
                                            Energy
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="coolant" onclick="setDatasetKey(this);">
                                            Coolant
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;" key="battery" onclick="setDatasetKey(this);">
                                            Battery
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="portlet-body">

                        <canvas id="myChart" width="500" height="400"></canvas>
                    </div>


                </div>
            </div>
-->
            <div class="col-md-5">
                    <!-- BEGIN INLINE NOTIFICATIONS PORTLET-->
                    <div class="portlet">
                        <div class="portlet-title">
                            <div class="caption">
                                <i class="fa fa-cogs"></i>Site 1 Devices
                            </div>
                            <div class="tools">
                                <a href="javascript:;" class="collapse">
                                </a>
                                <a href="#portlet-config" data-toggle="modal" class="config">
                                </a>
                                <a href="javascript:;" class="reload">
                                </a>
                                <a href="javascript:;" class="remove">
                                </a>
                            </div>
                        </div>
                        <div class="portlet-body">

                            <div class="table-scrollable">
                                <table class="table table-hover cell-border dataTable">
                                    <thead>
                                    <tr>
                                        <th></th>
                                        <th>DG 1 - SGP 1094</th>

                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td align="center">
                                            Project - Nural Island <br>Client: Zira <br> Capacity: 100Kva
                                        </td>
                                        <td>
                                            <img src="images/generator-set-250x250.jpg" class="img-circle" alt="Cinque Terre" height="100px" width="100px" border="1">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="heading">
                                            Nominal Power:
                                        </td>
                                        <td class="nominal_power">
                                            Loading ...
                                        </td>

                                    </tr>

                                    <tr>
                                        <td class="heading">
                                            Active Power:
                                        </td>
                                        <td class="active_power">
                                            Loading ...
                                        </td>

                                    </tr>

                                    <tr>
                                        <td class="heading">
                                            Apparent Power:
                                        </td>
                                        <td class="apprent_power">
                                            loading ...
                                        </td>

                                    </tr>

                                    <tr>
                                        <td class="heading">
                                            Line Voltage:
                                        </td>
                                        <td class="line_voltage">
                                            Loading ...
                                        </td>

                                    </tr>

                                    <tr>
                                        <td class="heading">
                                            Power Factor:
                                        </td>
                                        <td class="power_factor">
                                            Loading ...
                                        </td>

                                    </tr>

                                    <tr>
                                        <td  class="heading">
                                            Energy:
                                        </td>
                                        <td class="energy">
                                            Loading ...
                                        </td>

                                    </tr>

                                    <tr>
                                        <td class="heading">
                                            Mode:
                                        </td>
                                        <td>
                                            AUT
                                        </td>

                                    </tr>

                                    <tr>
                                        <td class="heading">
                                            Coolant:
                                        </td>
                                        <td class="coolant">
                                            Loading
                                        </td>

                                    </tr>

                                    <tr>
                                        <td class="heading">
                                            Battery:
                                        </td>
                                        <td class="battery">
                                            Loading ...
                                        </td>

                                    </tr>

                                    <tr>
                                        <td class="heading">
                                            Tank Capacity:
                                        </td>
                                        <td class="tank_cap">
                                            Loading ...
                                        </td>

                                    </tr>

                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                    <!-- END INLINE NOTIFICATIONS PORTLET-->

                </div>

            </div>


            <div class="row">
				
					<!-- END PORTLET-->
				</div>

        </div>

    </div>

    <div class="clearfix">
			</div>

		</div>
	</div>

</div>
<!-- END CONTAINER -->
<!-- BEGIN FOOTER -->
<div class="page-footer">
	<div class="page-footer-inner">
		 2017 &copy; TekAfforde Solutions.
    </div>
	<div class="scroll-to-top">
		<i class="icon-arrow-up"></i>
	</div>
</div>


<script src="plugins/jquery.min.js" type="text/javascript"></script>
<script src="plugins/datetimepicker/jquery.datetimepicker.full.min.js"></script>
<script src="plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script src="plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
<script src="plugins/metronic.js" type="text/javascript"></script>
<script src="plugins/chartjs/chart.min.js"></script>
<script src="plugins/bootstrap/js/toggle.js" type="text/javascript"></script>


<!-- END PAGE LEVEL PLUGINS -->
<!-- BEGIN PAGE LEVEL SCRIPTS -->
<!-- END PAGE LEVEL SCRIPTS -->
<script>

    $.datetimepicker.setLocale('en');

    $('#datetimepicker').datetimepicker({
        dayOfWeekStart : 1,
        lang:'en',
        hours12 :'24',
        startDate:	new Date() ,
        format:'d/m/Y H:i:s',       //	d/m/Y or Y/m/d
        formatDate:'Y/m/d',
        step:120, //60 minutes interval time show , max it allow 60 minutes interval only
        value   : new Date()
    });


    var selected_timestamp = null;
    var timer = null;
    var canvas = null;
    var datasetKey = 'active_power';
    var datasetKeyDesc = 'Active Power';
    var myLiveChart = null;
    var current_timestamp = null;

    function populateData(data,sortOrder){

//        console.log(data);
        var label = [];
        var points = [];

        if(myLiveChart == null){
            for(var i = data.docs.length-1; i >= 0; i--)
            {
                var date1 = data.docs[i].data_timestamp;
                var d = new Date(parseInt(date1));
                current_timestamp = date1;
                label.push(d.getHours()+ ':'+ d.getMinutes() + ':'+ d.getSeconds());
                points.push(eval('data.docs[i].d.'+datasetKey));
            }

            if(data.docs.length == 0){
                if(current_timestamp == null){
                    current_timestamp = new Date().getTime();
                }
                var d = new Date(current_timestamp);
                label.push(d.getHours()+ ':'+ d.getMinutes() + ':'+ d.getSeconds());
                points.push(0);
            }

            canvas = document.getElementById('myChart'),
                    ctx = canvas.getContext('2d'),
                    startingData = {
                        labels: label,
                        datasets: [
                            {
                                label: "fsfsferrger",
                                fillColor: "rgba(151,187,205,0.2)",
                                strokeColor: "rgba(151,187,205,1)",
                                pointColor: "rgba(151,187,205,1)",
                                pointStrokeColor: "#fff",
                                data: points
                            }
                        ]
                    },

            populateTable(data);
            myLiveChart = new Chart(ctx).Line(startingData, {animationSteps: 15});

        }else{

            if(data.docs.length == 0){

                var newDate = new Date();
                current_timestamp = newDate.getTime();
                myLiveChart.addData([0], newDate.getHours()+ ':'+ newDate.getMinutes() + ':'+ newDate.getSeconds());
                myLiveChart.removeData();
            }else{

                populateTable(data);

                for(var i = data.docs.length-1; i >= 0; i--)
                {
                    var date1 = data.docs[i].data_timestamp;
                    var d = new Date(parseInt(date1));
                    current_timestamp = date1;
                    myLiveChart.addData([eval('data.docs[i].d.'+datasetKey)], d.getHours()+ ':'+ d.getMinutes() + ':'+ d.getSeconds());
                    myLiveChart.removeData();
                }
            }

        }

        if(sortOrder != 'asc'){
            timer =  setTimeout(function(){
                invoke_service(populateData,20);
            }, 5000);
        }

    }

    function invoke_service(callback,limit,sortOrder){

        var post_body = '{ "selector": ' +
                '{ "device_type": "Generator" ' ;

        if(current_timestamp != null && limit > 1){
           var pastDate = new Date(current_timestamp);

            pastDate.setHours(23);
            pastDate.setMinutes(59);
            pastDate.setSeconds(59);
            post_body = post_body + ', "data_timestamp": { "$gt": '+current_timestamp+' }  ';
            if(sortOrder == 'asc'){
                post_body = post_body + ', "data_timestamp": { "$lt": '+pastDate.getTime()+' }  ';
            }
            post_body = post_body +'},'
        }else{
            post_body = post_body + '},';
        }

        post_body = post_body + '"fields": ["_id","_rev","device_type","device_id","data_timestamp","d.energy","d.nominal_power","d.line_voltage","d.coolant","d.mode","d.battery","d.tank_capacity","d.current", "d.apprent_power","d.active_power", "d.power_factor"],' ;
        if(sortOrder == null){
            post_body = post_body +  ' "sort": [{"device_type": "desc"},{"device_id": "desc"},{"data_timestamp": "desc"}], ';
        }else{
            post_body = post_body +  ' "sort": [{"device_type": "asc"},{"device_id": "asc"},{"data_timestamp": "asc"}], ';
        }

        post_body = post_body + '"limit": '+limit+', ' +
                '"skip": 0, ' +
                '"use_index":["_design/f7ed82b6c849da29fa8de968269701220661a4b5"] }';


        $.ajax({
            type: 'post',
            contentType: 'application/json',
            beforeSend: function (xhr) {
                xhr.setRequestHeader ("Authorization", "Basic " + btoa('bba026be-4c3d-4270-b651-26df5dc07671-bluemix' + ":" + '446854be7d110441252c2aeab46d49e67b14d67c04e7e9f111e4ffeb18458952'));
            },
            data: post_body,
            url: 'https://bba026be-4c3d-4270-b651-26df5dc07671-bluemix:446854be7d110441252c2aeab46d49e67b14d67c04e7e9f111e4ffeb18458952@bba026be-4c3d-4270-b651-26df5dc07671-bluemix.cloudant.com/db_device_data_1_18_02/_find',
            success: function(data) {
                callback(data,sortOrder);
            },
            error: function(jqXHR,textStatus,errorThrown) {
                console.log(errorThrown);
                console.log(textStatus);
                console.log(jqXHR)
            }
        });
    }


   function populateTable(data){

       var index = data.docs.length;
       if(index > 0){
           $('.nominal_power').text(data.docs[0].d.nominal_power+ ' kVA');
           $('.active_power').text(data.docs[0].d.active_power+ ' kVA');
           $('.apprent_power').text(data.docs[0].d.apprent_power+ ' kVA');
           $('.battery').text(data.docs[0].d.battery+ ' V');
           $('.coolant').text(data.docs[0].d.coolant+ ' °C');
           $('.power').text(data.docs[0].d.power);
           $('.power_factor').text(data.docs[0].d.power_factor);
           $('.energy').text(data.docs[0].d.energy+ ' kWH');
           $('.line_voltage').text(data.docs[0].d.line_voltage + ' V');
           $('.tank_cap').text(data.docs[0].d.tank_capacity + ' Liters');
       }

   }

    function clearGraph(){
        if(myLiveChart != null){
            myLiveChart.destroy();
        }

        myLiveChart = null;
        current_timestamp = null;
        clearTimeout(timer);
    }

    function setDatasetKey(evt){
        datasetKey = $(evt).attr('key');
        datasetKeyDesc = $(evt).text();
        $('.selected_criteria').text($(evt).text());
        clearGraph();
        invoke_service(populateData, 20);
    }

    jQuery(document).ready(function() {
        $('#trend_check_box').bootstrapToggle();
        invoke_service(populateData, 20);

    });


 $('#datetimepicker').datetimepicker({theme:'dark'});

    var monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
    ];

    $("#search_btn").on("click", function(e){
        var selectedDate = $('#datetimepicker').datetimepicker('getValue');
        selected_timestamp = selectedDate.getTime();
        var dateText = '<small class="del"> As of ' +selectedDate.getDate() + ' ' + monthNames[selectedDate.getMonth()] + ' ' + selectedDate.getFullYear()+' ' + selectedDate.getHours() +':'+selectedDate.getMinutes()+':'+selectedDate.getSeconds()+'</small>';
        $('.selected_criteria').html(datasetKeyDesc +dateText);
        clearGraph();
        current_timestamp = selected_timestamp;
        invoke_service(populateData, 20,'asc');
        $('#trend_check_box').bootstrapToggle('off');

    });

    $('#trend_check_box').change(function(){
        var isChecked = this.checked ;
       if(isChecked){

           $('.selected_criteria').html(datasetKeyDesc );
           clearGraph();
           invoke_service(populateData, 20);
       }  else{
           clearTimeout(timer);
       }
    });

</script>
<!-- END JAVASCRIPTS -->
</body>
<!-- END BODY -->
</html>